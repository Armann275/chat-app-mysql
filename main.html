<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viber-Style Chat</title>
    <style>
        /* Viber-inspired CSS */
        :root {
            --viber-primary: #7360F2;
            --viber-secondary: #8B7AF6;
            --viber-dark: #3D3D3D;
            --viber-light: #F5F5F5;
            --viber-text: #333333;
            --viber-time: #999999;
            --viber-received: #FFFFFF;
            --viber-sent: #E1F7CB;
            --viber-unread: #7360F2;
            --viber-system: #e6e6e6;
            --viber-danger: #ff4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        body {
            background-color: var(--viber-light);
            height: 100vh;
            display: flex;
            color: var(--viber-text);
        }

        /* Chat List Sidebar */
        .chat-list-container {
            width: 350px;
            background-color: white;
            border-right: 1px solid #e0e0e0;
            height: 100vh;
            overflow-y: auto;
        }

        .app-header {
            background-color: var(--viber-primary);
            color: white;
            padding: 15px 20px;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .search-bar {
            padding: 10px;
            background-color: #f8f8f8;
        }

        .search-bar input {
            width: 100%;
            padding: 8px 15px;
            border-radius: 18px;
            border: none;
            background-color: white;
            font-size: 14px;
        }

        .chat-list {
            list-style-type: none;
        }
 .logout-btn {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
        }

        .logout-confirmation-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 100;
            width: 350px;
            max-width: 90%;
        }

        .logout-confirmation-content {
            padding: 20px;
            text-align: center;
        }

        .logout-confirmation-message {
            margin-bottom: 20px;
            font-size: 16px;
        }
        .chat-item {
            display: flex;
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .chat-item:hover {
            background-color: #f9f9f9;
        }

        .chat-item.active {
            background-color: #f0f0f0;
        }

        .chat-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--viber-secondary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 12px;
            font-size: 18px;
        }

        .chat-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            overflow: hidden;
        }

        .chat-name {
            font-weight: 600;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
        }

        .chat-last-message {
            font-size: 14px;
            color: #777;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            justify-content: space-between;
        }

        .chat-time {
            font-size: 12px;
            color: var(--viber-time);
        }

        .unread-count {
            background-color: var(--viber-unread);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            margin-left: 5px;
        }

        /* Chat Window */
        .chat-window {
            flex: 1;
            display: none;
            flex-direction: column;
            height: 100vh;
            background-color: #e5ddd5;
            background-image: url('https://web.whatsapp.com/img/bg-chat-tile-light_a4be512e7195b6b733d9110b408f075d.png');
        }

        .chat-header {
            background-color: #ededed;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #e0e0e0;
        }

        .chat-header-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--viber-secondary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 12px;
        }

        .chat-header-info {
            flex: 1;
        }

        .chat-title {
            font-weight: 600;
        }

        .chat-status {
            font-size: 12px;
            color: var(--viber-time);
        }

        .chat-actions {
            display: flex;
            gap: 15px;
        }

        .chat-action-btn {
            background: none;
            border: none;
            color: var(--viber-dark);
            cursor: pointer;
            font-size: 18px;
        }

        .delete-chat-btn {
            background: none;
            border: none;
            color: var(--viber-danger);
            cursor: pointer;
            font-size: 18px;
            display: none;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .message {
            max-width: 70%;
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            position: relative;
            word-wrap: break-word;
        }

        .received {
            background-color: var(--viber-received);
            align-self: flex-start;
            border-top-left-radius: 0;
        }

        .sent {
            background-color: var(--viber-sent);
            align-self: flex-end;
            border-top-right-radius: 0;
        }

        .system {
            background-color: var(--viber-system);
            align-self: center;
            text-align: center;
            font-size: 13px;
            color: var(--viber-time);
            border-radius: 15px;
            padding: 6px 12px;
            margin: 5px auto;
            max-width: 80%;
        }

        .message-sender {
            font-size: 12px;
            font-weight: 600;
            color: var(--viber-primary);
            margin-bottom: 3px;
        }

        .message-time {
            font-size: 11px;
            color: var(--viber-time);
            text-align: right;
            margin-top: 3px;
        }

        .system .message-time {
            display: none;
        }

        .message-input-container {
            background-color: #f0f0f0;
            padding: 10px;
            display: flex;
            align-items: center;
        }

        .message-input {
            flex: 1;
            padding: 10px 15px;
            border-radius: 20px;
            border: none;
            margin: 0 10px;
            font-size: 14px;
        }

        .send-btn {
            background-color: var(--viber-primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        /* Popups */
        .popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 100;
            width: 400px;
            max-width: 90%;
        }

        .popup-header {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .popup-title {
            font-weight: 600;
            font-size: 18px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
        }

        .popup-content {
            padding: 15px;
        }

        .popup-input {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .popup-btn {
            background-color: var(--viber-primary);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .cancel-btn {
            background-color: #ddd;
            color: #333;
        }

        .danger-btn {
            background-color: var(--viber-danger);
            color: white;
        }

        /* Delete Confirmation Popup */
        .delete-confirmation-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 100;
            width: 350px;
            max-width: 90%;
        }

        .delete-confirmation-content {
            padding: 20px;
            text-align: center;
        }

        .delete-confirmation-message {
            margin-bottom: 20px;
            font-size: 16px;
        }

        /* User Search Popup */
        .user-search-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 100;
            width: 400px;
            max-width: 90%;
        }

        .user-search-results {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .user-result-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        .user-result-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--viber-secondary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
        }

        .user-result-info {
            flex: 1;
        }

        .user-result-name {
            font-weight: 600;
        }

        .user-result-email {
            font-size: 12px;
            color: #777;
        }

        .send-message-btn {
            background-color: var(--viber-primary);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 14px;
        }

        /* User Info Popup Styles */
        .user-info-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .user-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: var(--viber-primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 30px;
            margin-bottom: 20px;
        }

        .user-details {
            width: 100%;
        }

        .user-detail {
            display: flex;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .detail-label {
            font-weight: 600;
            width: 100px;
            color: var(--viber-dark);
        }

        .detail-value {
            flex: 1;
            color: var(--viber-text);
        }

        /* Notification */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--viber-primary);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 1000;
        }

        /* Message Delete Button */
       .delete-message-btn {
            position: absolute;
            left: -20px;
            top: 50%;
            transform: translateY(-50%);
            display: block;
        }

        .message:hover .delete-message-btn {
            display: block;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body>
    <div class="chat-list-container">
        <div class="app-header">
            <span>Messages</span>
            <div class="header-actions">
                <button class="chat-action-btn" id="userInfoBtn">üë§</button>
                <button class="chat-action-btn" id="searchUserBtn">üîç</button>
                <button class="chat-action-btn" id="newGroupBtn">‚úèÔ∏è</button>
                 <button class="logout-btn" id="logoutBtn">üö™</button>
            </div>
        </div>
        <div class="search-bar">
            <input type="text" placeholder="Search...">
        </div>
        <ul class="chat-list" id="chatList"></ul>
    </div>

    <div class="chat-window" id="chatWindow">
        <div class="chat-header">
            <div class="chat-header-avatar" id="chatAvatar">G</div>
            <div class="chat-header-info">
                <div class="chat-title" id="chatTitle">Group Name</div>
                <div class="chat-status" id="chatStatus">online</div>
            </div>
            <div class="chat-actions">
                <button class="chat-action-btn" id="viewUsersBtn">üë•</button>
                <button class="chat-action-btn" id="addUsersBtn">‚ûï</button>
                <button class="chat-action-btn" id="leaveGroupBtn">üö™</button>
                <button class="chat-action-btn" id="renameGroupBtn">‚úèÔ∏è</button>
                <button class="delete-chat-btn" id="deleteChatBtn">üóëÔ∏è</button>
            </div>
        </div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="message-input-container">
            <button class="chat-action-btn">üòä</button>
            <input type="text" class="message-input" id="chatInput" placeholder="Type a message...">
            <button class="send-btn" id="sendMessage">‚û§</button>
        </div>
    </div>

    <!-- Delete Confirmation Popup -->
    <div class="delete-confirmation-popup" id="deleteConfirmationPopup">
        <div class="popup-header">
            <div class="popup-title">Delete Chat</div>
            <button class="close-btn" id="closeDeleteConfirmationBtn">&times;</button>
        </div>
        <div class="delete-confirmation-content">
            <div class="delete-confirmation-message">Are you sure you want to delete this chat?</div>
            <div class="action-buttons">
                <button class="popup-btn cancel-btn" id="cancelDeleteChatBtn">Cancel</button>
                <button class="popup-btn danger-btn" id="confirmDeleteChatBtn">Delete</button>
            </div>
        </div>
    </div>

    <!-- User Search Popup -->
    <div class="user-search-popup" id="userSearchPopup">
        <div class="popup-header">
            <div class="popup-title">Search Users</div>
            <button class="close-btn" id="closeUserSearchBtn">&times;</button>
        </div>
        <div class="popup-content">
            <input type="text" class="popup-input" id="userSearchInput" placeholder="Type to search users...">
            <div class="user-search-results" id="userSearchResults"></div>
        </div>
    </div>

    <!-- User Info Popup -->
    <div class="popup" id="userInfoPopup">
        <div class="popup-header">
            <div class="popup-title">My Profile</div>
            <button class="close-btn" id="closeUserInfoBtn">&times;</button>
        </div>
        <div class="popup-content">
            <div class="user-info-container">
                <div class="user-avatar" id="userInfoAvatar">U</div>
                <div class="user-details">
                    <div class="user-detail">
                        <span class="detail-label">Username:</span>
                        <span class="detail-value" id="userInfoUsername"></span>
                    </div>
                    <div class="user-detail">
                        <span class="detail-label">Email:</span>
                        <span class="detail-value" id="userInfoEmail"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User List Popup -->
    <div class="popup" id="userListPopup">
        <div class="popup-header">
            <div class="popup-title">Group Members</div>
            <button class="close-btn" id="closeUserListBtn">&times;</button>
        </div>
        <div class="popup-content">
            <ul id="userList" class="user-list"></ul>
        </div>
    </div>

    <!-- New Group Popup -->
    <div class="popup" id="newGroupPopup">
        <div class="popup-header">
            <div class="popup-title">New Group</div>
            <button class="close-btn" id="closeNewGroupBtn">&times;</button>
        </div>
        <div class="popup-content">
            <input type="text" class="popup-input" id="groupName" placeholder="Group name">
            <input type="text" class="popup-input" id="searchUsers" placeholder="Search users">
            <ul id="searchResults" class="user-list"></ul>
            <button class="popup-btn" id="createGroupBtn">Create Group</button>
        </div>
    </div>

    <!-- Add Users Popup -->
    <div class="popup" id="addUsersPopup">
        <div class="popup-header">
            <div class="popup-title">Add Users</div>
            <button class="close-btn" id="closeAddUsersBtn">&times;</button>
        </div>
        <div class="popup-content">
            <input type="text" class="popup-input" id="searchNewUsers" placeholder="Search users">
            <ul id="newUserResults" class="user-list"></ul>
            <button class="popup-btn" id="addSelectedUsersBtn">Add Users</button>
        </div>
    </div>

    <!-- Rename Group Popup -->
    <div class="popup" id="renameGroupPopup">
        <div class="popup-header">
            <div class="popup-title">Rename Group</div>
            <button class="close-btn" id="closeRenameGroupBtn">&times;</button>
        </div>
        <div class="popup-content">
            <input type="text" class="popup-input" id="newGroupName" placeholder="New group name">
            <div class="action-buttons">
                <button class="popup-btn cancel-btn" id="cancelRenameGroupBtn">Cancel</button>
                <button class="popup-btn" id="confirmRenameGroupBtn">Rename</button>
            </div>
        </div>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification"></div>
<div class="logout-confirmation-popup" id="logoutConfirmationPopup">
        <div class="popup-header">
            <div class="popup-title">Confirm Logout</div>
            <button class="close-btn" id="closeLogoutPopup">&times;</button>
        </div>
        <div class="logout-confirmation-content">
            <div class="logout-confirmation-message">Are you sure you want to logout?</div>
            <div class="action-buttons">
                <button class="popup-btn cancel-btn" id="cancelLogoutBtn">Cancel</button>
                <button class="popup-btn danger-btn" id="confirmLogoutBtn">Logout</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        
        let token = localStorage.getItem('token');
        const userId = +localStorage.getItem('userId');
        socket.emit("join user", userId);

        if (!token) {
            alert('You need to login first!');
            window.location.href = '/login';
        }

        let currentChatId = null;
        let selectedUsers = [];
        let selectedNewUsers = [];
        let currentChatParticipants = [];
        let currentChat = null;
        let unreadCounts = {};
        let allChats = [];
        let currentUserRole = null;
        let hasAdmin = false;
        let isRefreshingToken = false;
        let refreshQueue = [];

        // Store messages by chat ID
        let messagesData = {};

        // Function to generate avatar color based on name
        function getAvatarColor(name) {
            const colors = ['#7360F2', '#8B7AF6', '#6A5ACD', '#9370DB', '#7B68EE'];
            const index = name.charCodeAt(0) % colors.length;
            return colors[index];
        }

        // Function to get initials from name
        function getInitials(name) {
            return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
        }

        // Function to refresh the access token
        async function refreshToken() {
            if (isRefreshingToken) {
                // If we're already refreshing, return a promise that will resolve when the refresh is complete
                return new Promise((resolve) => {
                    refreshQueue.push(resolve);
                });
            }

            isRefreshingToken = true;
            
            try {
                const response = await fetch('/refresh', {
                    method: 'POST',
                    credentials: 'include' // Important for sending cookies
                });

                if (response.ok) {
                    const data = await response.json();
                    token = data.token;
                    localStorage.setItem('token', token);
                    
                    // Process all queued requests
                    while (refreshQueue.length) {
                        const resolve = refreshQueue.shift();
                        resolve();
                    }
                    
                    return true;
                } else {
                    // If refresh fails, redirect to login
                    localStorage.removeItem('token');
                    localStorage.removeItem('userId');
                    window.location.href = '/login';
                    return false;
                }
            } catch (error) {
                console.error('Error refreshing token:', error);
                localStorage.removeItem('token');
                localStorage.removeItem('userId');
                window.location.href = '/login';
                return false;
            } finally {
                isRefreshingToken = false;
            }
        }

        // Wrapper function for API calls with token refresh
        async function fetchWithAuth(url, options = {}) {
            // Set default headers if not provided
            options.headers = options.headers || {};
            options.headers['Authorization'] = `Bearer ${token}`;
            
            // Make the initial request
            let response = await fetch(url, options);
            
            // If unauthorized, try to refresh the token
            if (response.status === 401) {
                console.log("401");
                
                const refreshSuccess = await refreshToken();
                
                if (refreshSuccess) {
                    // Retry the original request with the new token
                    options.headers['Authorization'] = `Bearer ${token}`;
                    response = await fetch(url, options);
                    
                    // If still unauthorized after refresh, redirect to login
                    if (response.status === 401) {
                        localStorage.removeItem('token');
                        localStorage.removeItem('userId');
                        window.location.href = '/login';
                        return null;
                    }
                } else {
                    // If refresh failed, we've already redirected to login
                    return null;
                }
            }
            
            return response;
        }

        // Function to fetch chats
        async function fetchChats() {
            try {
                const response = await fetchWithAuth('/getAllChats');
                if (!response) return; // Redirect happened
                
                const data = await response.json();
                const { chats, chatParticipants, currentUserId } = data;
                
                allChats = chats;
                const chatList = document.getElementById('chatList');
                chatList.innerHTML = '';

                const chatIds = [];

                // Sort chats by last message time (newest first)
                chats.sort((a, b) => {
                    const aTime = a.lastMessage ? new Date(a.lastMessage.created_at).getTime() : 0;
                    const bTime = b.lastMessage ? new Date(b.lastMessage.created_at).getTime() : 0;
                    return bTime - aTime;
                });

                chats.forEach(chat => {
                    chatIds.push(chat.id);
                    addChatToList(chat, chatParticipants, currentUserId);
                });
                
                socket.emit('join chat', chatIds);
            } catch (error) {
                console.error('Error fetching chats:', error);
            }
        }

        // Function to add a chat to the chat list
        function addChatToList(chat, chatParticipants, currentUserId) {
            const chatList = document.getElementById('chatList');
            let chatName = '';
            let lastMessage = '';
            let isGroupChat = chat.isGroup === 1;

            if (!isGroupChat) {
                const participants = chatParticipants.filter(p => p.chat_id === chat.id && p.user_id !== currentUserId);
                chatName = participants[0]?.username || 'Unknown';
                lastMessage = chat.lastMessage?.message && chat.lastMessage?.sender?.username ? 
                    formatLastMessage(chat.lastMessage) : '';
            } else {
                chatName = chat.groupName;
                lastMessage = chat.lastMessage?.message ? 
                    formatLastMessage(chat.lastMessage) : '';
            }

            const chatItem = document.createElement('li');
            chatItem.classList.add('chat-item');
            chatItem.dataset.chatId = chat.id;
            
            // Create avatar
            const avatar = document.createElement('div');
            avatar.classList.add('chat-avatar');
            avatar.style.backgroundColor = getAvatarColor(chatName);
            avatar.textContent = getInitials(chatName);
            chatItem.appendChild(avatar);
            
            // Create chat info
            const chatInfo = document.createElement('div');
            chatInfo.classList.add('chat-info');
            
            const nameRow = document.createElement('div');
            nameRow.classList.add('chat-name');
            nameRow.textContent = chatName;
            
            const timeSpan = document.createElement('span');
            timeSpan.classList.add('chat-time');
            timeSpan.textContent = chat.lastMessage ? 
                formatTime(chat.lastMessage.created_at) : '';
            nameRow.appendChild(timeSpan);
            
            chatInfo.appendChild(nameRow);
            
            const messageRow = document.createElement('div');
            messageRow.classList.add('chat-last-message');
            messageRow.textContent = lastMessage || 'No messages yet';
            
            // Add unread count badge if there are unread messages
            if (unreadCounts[chat.id] && unreadCounts[chat.id] > 0) {
                const unreadBadge = document.createElement('span');
                unreadBadge.classList.add('unread-count');
                unreadBadge.textContent = unreadCounts[chat.id];
                messageRow.appendChild(unreadBadge);
            }
            
            chatInfo.appendChild(messageRow);
            chatItem.appendChild(chatInfo);
            
            chatItem.onclick = () => {
                // Clear unread count when opening chat
                if (unreadCounts[chat.id]) {
                    unreadCounts[chat.id] = 0;
                    const badge = chatItem.querySelector('.unread-count');
                    if (badge) {
                        badge.remove();
                    }
                }
                openChatWindow(chat, chatParticipants, currentUserId);
            };
            
            // Insert at the top of the list
            if (chatList.firstChild) {
                chatList.insertBefore(chatItem, chatList.firstChild);
            } else {
                chatList.appendChild(chatItem);
            }
        }

        // Format last message for display in chat list
        function formatLastMessage(message) {
            if (message.isSystem) {
                return message.message;
            }
            return message.sender?.username ? `${message.sender.username}: ${message.message}` : message.message;
        }

        // Format time for display
        function formatTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            
            if (date.toDateString() === now.toDateString()) {
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } else if (date.getFullYear() === now.getFullYear()) {
                return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
            } else {
                return date.toLocaleDateString([], { year: 'numeric', month: 'short', day: 'numeric' });
            }
        }

        // Open the chat window and fetch messages
        async function openChatWindow(chat, chatParticipants, currentUserId) {
            const chatWindow = document.getElementById('chatWindow');
            const chatTitle = document.getElementById('chatTitle');
            const chatAvatar = document.getElementById('chatAvatar');
            const chatMessages = document.getElementById('chatMessages');
            const chatInput = document.getElementById('chatInput');
            const usersBtn = document.getElementById('viewUsersBtn');
            const addUsersBtn = document.getElementById('addUsersBtn');
            const leaveGroupBtn = document.getElementById('leaveGroupBtn');
            const renameGroupBtn = document.getElementById('renameGroupBtn');
            const deleteChatBtn = document.getElementById('deleteChatBtn');

            currentChatId = chat.id;
            currentChat = chat;
            currentChatParticipants = chatParticipants.filter(p => p.chat_id === chat.id);
            
            // Find current user's role in this chat and check if there's an admin
            const currentUserParticipant = currentChatParticipants.find(p => p.user_id === currentUserId);
            currentUserRole = currentUserParticipant ? currentUserParticipant.role : null;
            
            // Check if there's any admin in the group
            hasAdmin = currentChatParticipants.some(p => p.role === 'admin');

            if (chat.isGroup) {
                chatTitle.textContent = chat.groupName;
                chatAvatar.textContent = getInitials(chat.groupName);
                chatAvatar.style.backgroundColor = getAvatarColor(chat.groupName);
                usersBtn.style.display = 'block';
                addUsersBtn.style.display = 'block';
                leaveGroupBtn.style.display = 'block';
                renameGroupBtn.style.display = currentUserRole === 'admin' ? 'block' : 'none';
                deleteChatBtn.style.display = 'none';
            } else {
                const oppositeUser = chatParticipants.find(p => p.chat_id === chat.id && p.user_id !== currentUserId);
                chatTitle.textContent = oppositeUser.username;
                chatAvatar.textContent = getInitials(oppositeUser.username);
                chatAvatar.style.backgroundColor = getAvatarColor(oppositeUser.username);
                usersBtn.style.display = 'none';
                addUsersBtn.style.display = 'none';
                leaveGroupBtn.style.display = 'none';
                renameGroupBtn.style.display = 'none';
                deleteChatBtn.style.display = 'block';
            }

            chatMessages.innerHTML = '';
            chatWindow.style.display = 'flex';

            // Check if we already have messages for this chat
            if (messagesData[chat.id]) {
                // Display existing messages
                messagesData[chat.id].forEach(message => appendMessage(message));
            } else {
                // Fetch messages for the current chat
                const messagesResponse = await fetchMessages(currentChatId);
                if (messagesResponse) {
                    // Store messages in our messagesData object
                    messagesData[chat.id] = messagesResponse;
                    messagesResponse.forEach(message => appendMessage(message));
                }
            }

            // Remove previous event listeners if they exist
            document.getElementById('sendMessage').onclick = null;
            chatInput.onkeypress = null;

            // Send message handler - using onclick assignment instead of addEventListener
            document.getElementById('sendMessage').onclick = async () => {
                const message = chatInput.value.trim();
                if (message) {
                    const response = await sendMessageToAPI(currentChatId, message);
                    if (response && response.success) {
                        chatInput.value = '';
                    } else if (response && !response.success) {
                        alert('Failed to send message');
                    }
                }
            };

            // Also send message on Enter key - using onkeypress assignment
            chatInput.onkeypress = async (e) => {
                if (e.key === 'Enter') {
                    const message = chatInput.value.trim();
                    if (message) {
                        const response = await sendMessageToAPI(currentChatId, message);
                        if (response && response.success) {
                            chatInput.value = '';
                        } else if (response && !response.success) {
                            alert('Failed to send message');
                        }
                    }
                }
            };

            // Show users in a group chat when clicking "View Users"
            usersBtn.onclick = () => showUsers(chat, currentChatParticipants);

            // Add users to group chat when clicking "Add Users"
            addUsersBtn.onclick = () => {
                document.getElementById('addUsersPopup').style.display = 'block';
                document.getElementById('searchNewUsers').value = '';
                document.getElementById('newUserResults').innerHTML = '';
                selectedNewUsers = [];
            };

            // Leave group button handler
            leaveGroupBtn.onclick = () => {
                if (confirm('Are you sure you want to leave this group?')) {
                    leaveGroup();
                }
            };

            // Rename group button handler
            renameGroupBtn.onclick = () => {
                document.getElementById('renameGroupPopup').style.display = 'block';
                document.getElementById('newGroupName').value = currentChat.groupName;
            };

            // Delete chat button handler
            deleteChatBtn.onclick = () => {
                document.getElementById('deleteConfirmationPopup').style.display = 'block';
            };
        }

        // Fetch messages for a specific chat
        async function fetchMessages(chatId) {
            try {
                const response = await fetchWithAuth(`/getMessages/${chatId}`);
                if (!response) return []; // Redirect happened
                
                const data = await response.json();
                return data.messages;
            } catch (error) {
                console.error('Error fetching messages:', error);
                return [];
            }
        }

        // Append message to the chat window
       function appendMessage(message) {
            const chatMessages = document.getElementById('chatMessages');
            const messageElement = document.createElement('div');

            if (message.isSystem) {
                messageElement.classList.add('message', 'system');
                messageElement.innerHTML = `<div>${message.message}</div>`;
            } else {
                const messageClass = message.sender.senderId === userId ? 'sent' : 'received';
                messageElement.classList.add('message', messageClass);
                messageElement.dataset.messageId = message.id;

                if (message.sender.senderId !== userId && currentChat.isGroup) {
                    const senderName = document.createElement('div');
                    senderName.classList.add('message-sender');
                    senderName.textContent = message.sender.username;
                    messageElement.appendChild(senderName);
                }

                if (message.repliedMessage) {
                    const replyDiv = document.createElement('div');
                    replyDiv.style.borderLeft = '3px solid #ccc';
                    replyDiv.style.marginBottom = '5px';
                    replyDiv.style.paddingLeft = '10px';
                    replyDiv.innerHTML = `<div style="font-weight:bold;font-size:12px;color:#555">${message.repliedMessage.sender.username}</div><div style="font-size:12px;color:#555">${message.repliedMessage.message}</div>`;
                    messageElement.appendChild(replyDiv);
                }

                const contentDiv = document.createElement('div');
                contentDiv.textContent = message.message;
                if (message.isDeleted === 1) {
                    contentDiv.style.fontStyle = 'italic';
                    contentDiv.style.color = '#888';
                }
                messageElement.appendChild(contentDiv);

                const timeDiv = document.createElement('div');
                timeDiv.classList.add('message-time');
                timeDiv.textContent = formatTime(message.created_at);
                messageElement.appendChild(timeDiv);

                if (message.sender.senderId === userId && !message.isDeleted) {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.classList.add('delete-message-btn');
                    deleteBtn.innerHTML = 'üóëÔ∏è';
                    deleteBtn.onclick = async (e) => {
                        e.stopPropagation();
                        if (confirm('Are you sure you want to delete this message?')) {
                            await deleteMessage(message.id);
                        }
                    };
                    messageElement.insertBefore(deleteBtn, messageElement.firstChild);
                }
            }

            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Delete a message
         async function deleteMessage(messageId) {
            try {
                const response = await fetchWithAuth('/deleteMessage', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        chatId: currentChatId,
                        messageId: messageId
                    })
                });

                if (!response) return;

                const data = await response.json();
                if (response.ok) {
                    const chatMessages = messagesData[currentChatId];
                    if (chatMessages) {
                        const messageIndex = chatMessages.findIndex(m => m.id === messageId);
                        if (messageIndex !== -1) {
                            chatMessages[messageIndex] = data.message;
                        }
                    }

                    // Re-render the message using appendMessage
                    const messageElement = document.querySelector(`.message[data-message-id="${messageId}"]`);
                    if (messageElement) {
                        messageElement.remove();
                    }
                    appendMessage(data.message);

                    // Emit to others
                    socket.emit('messageDeleted', currentChatId, data.message);

                    showNotification('Message deleted successfully');
                } else {
                    throw new Error(data.message || 'Failed to delete message');
                }
            } catch (error) {
                console.error('Error deleting message:', error);
                showNotification('Error deleting message');
            }
        }
        
        // Send message to the API
        async function sendMessageToAPI(chatId, message) {
            try {
                const response = await fetchWithAuth(`/sendMessage/${chatId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message })
                });
                
                if (!response) return { success: false, message: 'Error sending message' }; // Redirect happened
                
                const data = await response.json();
                if (response.ok) {
                    // Add the new message to our messagesData storage
                    if (!messagesData[chatId]) {
                        messagesData[chatId] = [];
                    }
                    messagesData[chatId].push(data.message);
                    console.log(messagesData);
                    
                    socket.emit('sendMessage', chatId, data.message);
                    return { success: true, message: data.message };
                } else {
                    return { success: false, message: data.message || 'Error sending message' };
                }
            } catch (error) {
                console.error('Error sending message:', error);
                return { success: false, message: 'Error sending message' };
            }
        }

        // Show users in the group chat
        function showUsers(chat, chatParticipants) {
            const userListPopup = document.getElementById('userListPopup');
            const userList = document.getElementById('userList');
            userList.innerHTML = '';
            
            const participants = chatParticipants.filter(p => p.chat_id === chat.id);
            participants.forEach(p => {
                const userItem = document.createElement('li');
                userItem.classList.add('user-item');
                userItem.style.display = 'flex';
                userItem.style.alignItems = 'center';
                userItem.style.padding = '8px 0';
                
                // Create avatar
                const avatar = document.createElement('div');
                avatar.style.width = '36px';
                avatar.style.height = '36px';
                avatar.style.borderRadius = '50%';
                avatar.style.backgroundColor = getAvatarColor(p.username);
                avatar.style.color = 'white';
                avatar.style.display = 'flex';
                avatar.style.alignItems = 'center';
                avatar.style.justifyContent = 'center';
                avatar.style.fontWeight = 'bold';
                avatar.style.marginRight = '10px';
                avatar.textContent = getInitials(p.username);
                
                // Create user info
                const userInfo = document.createElement('div');
                userInfo.style.flex = '1';
                userInfo.innerHTML = `<div>${p.username}</div><div style="font-size:12px;color:#777">${p.role || 'member'}</div>`;
                
                // Create delete button (only visible for admin and not for themselves)
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Remove';
                deleteBtn.style.background = 'none';
                deleteBtn.style.border = 'none';
                deleteBtn.style.color = '#ff4444';
                deleteBtn.style.cursor = 'pointer';
                deleteBtn.style.fontSize = '12px';
                deleteBtn.dataset.userId = p.user_id;
                
                // Only show delete button if current user is admin and it's not themselves
                if (currentUserRole === 'admin' && p.user_id !== userId) {
                    deleteBtn.style.display = 'block';
                } else {
                    deleteBtn.style.display = 'none';
                }
                
                deleteBtn.onclick = async (e) => {
                    e.stopPropagation();
                    if (confirm(`Are you sure you want to remove ${p.username} from this group?`)) {
                        try {
                            const response = await fetchWithAuth('/deleteUserFromChat', {
                                method: 'DELETE',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    userId: p.user_id,
                                    chatId: currentChatId
                                })
                            });
                            
                            if (!response) return; // Redirect happened
                            
                            if (response.ok) {
                                // Remove the user from the list
                                userItem.remove();
                                
                                // Update current participants list
                                currentChatParticipants = currentChatParticipants.filter(
                                    participant => participant.user_id !== p.user_id
                                );
                                
                                // Show success notification
                                showNotification(`${p.username} has been removed from the group`);
                            } else {
                                const errorData = await response.json();
                                throw new Error(errorData.message || 'Failed to delete user');
                            }
                        } catch (error) {
                            console.error('Error deleting user:', error);
                            alert(error.message);
                        }
                    }
                };
                
                userItem.appendChild(avatar);
                userItem.appendChild(userInfo);
                userItem.appendChild(deleteBtn);
                userList.appendChild(userItem);
            });

            userListPopup.style.display = 'block';
        }

        // Leave group function
        async function leaveGroup() {
            try {
                const response = await fetchWithAuth('/leaveGroup', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        chatId: currentChatId
                    })
                });

                if (!response) return; // Redirect happened
                
                const data = await response.json();
                if (response.ok) {
                    showNotification(data.message || 'You have left the group successfully');
                    document.getElementById('chatWindow').style.display = 'none';
                    
                    // Remove messages from storage for this chat
                    delete messagesData[currentChatId];
                    
                    fetchChats(); // Refresh the chat list
                } else {
                    throw new Error(data.message || 'Failed to leave group');
                }
            } catch (error) {
                console.error('Error leaving group:', error);
                alert(error.message);
            }
        }

        // Delete chat function
        async function deleteChat() {
            try {
                const response = await fetchWithAuth('/deleteChat', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        chatId: currentChatId
                    })
                });

                if (!response) return; // Redirect happened
                
                const data = await response.json();
                if (response.ok) {
                    showNotification('Chat deleted successfully');
                    document.getElementById('chatWindow').style.display = 'none';
                    document.getElementById('deleteConfirmationPopup').style.display = 'none';
                    
                    // Remove the chat from the UI
                    const chatItem = document.querySelector(`.chat-item[data-chat-id="${currentChatId}"]`);
                    if (chatItem) {
                        chatItem.remove();
                    }
                    
                    // Remove from allChats array
                    allChats = allChats.filter(chat => chat.id !== currentChatId);
                    
                    // Remove messages from storage
                    delete messagesData[currentChatId];
                    
                    // Reset current chat
                    currentChatId = null;
                    currentChat = null;
                } else {
                    throw new Error(data.message || 'Failed to delete chat');
                }
            } catch (error) {
                console.error('Error deleting chat:', error);
                alert(error.message);
            }
        }

        // User info button click handler
        document.getElementById('userInfoBtn').addEventListener('click', async () => {
            try {
                const response = await fetchWithAuth('/getMyinfo');
                if (!response) return; // Redirect happened
                
                if (response.ok) {
                    const userData = await response.json();
                    displayUserInfo(userData);
                } else {
                    throw new Error('Failed to fetch user info');
                }
            } catch (error) {
                console.error('Error fetching user info:', error);
                showNotification('Error fetching user info');
            }
        });

        // Close user info popup
        document.getElementById('closeUserInfoBtn').addEventListener('click', () => {
            document.getElementById('userInfoPopup').style.display = 'none';
        });

        // Function to display user info in the popup
        function displayUserInfo(userData) {
            const userInfoPopup = document.getElementById('userInfoPopup');
            const userAvatar = document.getElementById('userInfoAvatar');
            const usernameElement = document.getElementById('userInfoUsername');
            const emailElement = document.getElementById('userInfoEmail');
            
            // Set user info
            userAvatar.textContent = getInitials(userData.username);
            userAvatar.style.backgroundColor = getAvatarColor(userData.username);
            usernameElement.textContent = userData.username;
            emailElement.textContent = userData.email;
            
            // Show popup
            userInfoPopup.style.display = 'block';
        }

        // Close buttons functionality
        document.getElementById('closeUserListBtn').addEventListener('click', () => {
            document.getElementById('userListPopup').style.display = 'none';
        });

        document.getElementById('closeNewGroupBtn').addEventListener('click', () => {
            document.getElementById('newGroupPopup').style.display = 'none';
        });

        document.getElementById('closeAddUsersBtn').addEventListener('click', () => {
            document.getElementById('addUsersPopup').style.display = 'none';
        });

        document.getElementById('closeRenameGroupBtn').addEventListener('click', () => {
            document.getElementById('renameGroupPopup').style.display = 'none';
        });

        document.getElementById('cancelRenameGroupBtn').addEventListener('click', () => {
            document.getElementById('renameGroupPopup').style.display = 'none';
        });

        document.getElementById('closeDeleteConfirmationBtn').addEventListener('click', () => {
            document.getElementById('deleteConfirmationPopup').style.display = 'none';
        });

        document.getElementById('cancelDeleteChatBtn').addEventListener('click', () => {
            document.getElementById('deleteConfirmationPopup').style.display = 'none';
        });

        // Confirm delete chat button
        document.getElementById('confirmDeleteChatBtn').addEventListener('click', () => {
            deleteChat();
        });

        // Create group button
        document.getElementById('newGroupBtn').addEventListener('click', () => {
            document.getElementById('newGroupPopup').style.display = 'block';
            document.getElementById('groupName').value = '';
            document.getElementById('searchUsers').value = '';
            document.getElementById('searchResults').innerHTML = '';
            selectedUsers = [];
        });

        // Search users button (new feature)
        document.getElementById('searchUserBtn').addEventListener('click', () => {
            document.getElementById('userSearchPopup').style.display = 'block';
            document.getElementById('userSearchInput').value = '';
            document.getElementById('userSearchResults').innerHTML = '';
        });

        // Close user search popup
        document.getElementById('closeUserSearchBtn').addEventListener('click', () => {
            document.getElementById('userSearchPopup').style.display = 'none';
        });

        // Search users while typing (for private chat creation)
        const userSearchInput = document.getElementById('userSearchInput');
        userSearchInput.addEventListener('input', async (e) => {
            const search = e.target.value.trim();
            if (search) {
                try {
                    const response = await fetchWithAuth(`/searchUsers?q=${search}`);
                    if (!response) return; // Redirect happened
                    
                    const data = await response.json();
                    const searchResults = document.getElementById('userSearchResults');
                    searchResults.innerHTML = '';
                    
                    if (data.users && data.users.length > 0) {
                        data.users.forEach(user => {
                            const userItem = document.createElement('div');
                            userItem.classList.add('user-result-item');
                            
                            // Create avatar
                            const avatar = document.createElement('div');
                            avatar.classList.add('user-result-avatar');
                            avatar.style.backgroundColor = getAvatarColor(user.username);
                            avatar.textContent = getInitials(user.username);
                            
                            // Create user info
                            const userInfo = document.createElement('div');
                            userInfo.classList.add('user-result-info');
                            userInfo.innerHTML = `
                                <div class="user-result-name">${user.username}</div>
                                <div class="user-result-email">${user.email}</div>
                            `;
                            
                            // Create send message button
                            const sendBtn = document.createElement('button');
                            sendBtn.classList.add('send-message-btn');
                            sendBtn.textContent = 'Message';
                            sendBtn.dataset.userId = user.id;
                            sendBtn.dataset.username = user.username;
                            
                            sendBtn.addEventListener('click', async () => {
                                try {
                                    const response = await fetchWithAuth('/createPrivateChat', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json'
                                        },
                                        body: JSON.stringify({
                                            targetUserId: user.id
                                        })
                                    });
                                    
                                    if (!response) return; // Redirect happened
                                    
                                    const data = await response.json();
                                    if (response.ok) {
                                        showNotification(`Chat created with ${user.username}`);
                                        document.getElementById('userSearchPopup').style.display = 'none';
                                        fetchChats(); // Refresh the chat list
                                    } else {
                                        throw new Error(data.message || 'Failed to create chat');
                                    }
                                } catch (error) {
                                    console.error('Error creating private chat:', error);
                                    alert(error.message);
                                }
                            });
                            
                            userItem.appendChild(avatar);
                            userItem.appendChild(userInfo);
                            userItem.appendChild(sendBtn);
                            searchResults.appendChild(userItem);
                        });
                    } else {
                        searchResults.innerHTML = '<div style="padding: 10px; text-align: center; color: #777;">No users found</div>';
                    }
                } catch (error) {
                    console.error('Error searching users:', error);
                    document.getElementById('userSearchResults').innerHTML = 
                        '<div style="padding: 10px; text-align: center; color: #ff4444;">Error searching users</div>';
                }
            } else {
                document.getElementById('userSearchResults').innerHTML = '';
            }
        });

        // Search users while typing (for new group creation)
        const searchUsersInput = document.getElementById('searchUsers');
        searchUsersInput.addEventListener('input', async (e) => {
            const search = e.target.value.trim();
            if (search) {
                const response = await fetchWithAuth(`/searchUsers?q=${search}`);
                if (!response) return; // Redirect happened
                
                const data = await response.json();
                const searchResults = document.getElementById('searchResults');
                searchResults.innerHTML = '';
                data.users.forEach(user => {
                    const userItem = document.createElement('li');
                    userItem.classList.add('user-item');
                    userItem.style.display = 'flex';
                    userItem.style.alignItems = 'center';
                    userItem.style.padding = '8px 0';
                    userItem.style.cursor = 'pointer';
                    
                    // Create avatar
                    const avatar = document.createElement('div');
                    avatar.style.width = '36px';
                    avatar.style.height = '36px';
                    avatar.style.borderRadius = '50%';
                    avatar.style.backgroundColor = getAvatarColor(user.username);
                    avatar.style.color = 'white';
                    avatar.style.display = 'flex';
                    avatar.style.alignItems = 'center';
                    avatar.style.justifyContent = 'center';
                    avatar.style.fontWeight = 'bold';
                    avatar.style.marginRight = '10px';
                    avatar.textContent = getInitials(user.username);
                    
                    // Create user info
                    const userInfo = document.createElement('div');
                    userInfo.style.flex = '1';
                    userInfo.textContent = user.username;
                    
                    userItem.appendChild(avatar);
                    userItem.appendChild(userInfo);
                    
                    userItem.onclick = () => {
                        if (selectedUsers.includes(user.id)) {
                            selectedUsers = selectedUsers.filter(id => id !== user.id);
                            userItem.style.backgroundColor = '';
                        } else {
                            selectedUsers.push(user.id);
                            userItem.style.backgroundColor = '#f0f0f0';
                        }
                    };
                    searchResults.appendChild(userItem);
                });
            }
        });

        // Search users to add to existing group
        const searchNewUsersInput = document.getElementById('searchNewUsers');
        searchNewUsersInput.addEventListener('input', async (e) => {
            const search = e.target.value.trim();
            if (search && currentChatId) {
                const response = await fetchWithAuth(`/searchUsers?q=${search}&chatId=${currentChatId}`);
                if (!response) return; // Redirect happened
                
                const data = await response.json();
                const searchResults = document.getElementById('newUserResults');
                searchResults.innerHTML = '';
                data.users.forEach(user => {
                    const userItem = document.createElement('li');
                    userItem.classList.add('user-item');
                    userItem.style.display = 'flex';
                    userItem.style.alignItems = 'center';
                    userItem.style.padding = '8px 0';
                    userItem.style.cursor = 'pointer';
                    
                    // Create avatar
                    const avatar = document.createElement('div');
                    avatar.style.width = '36px';
                    avatar.style.height = '36px';
                    avatar.style.borderRadius = '50%';
                    avatar.style.backgroundColor = getAvatarColor(user.username);
                    avatar.style.color = 'white';
                    avatar.style.display = 'flex';
                    avatar.style.alignItems = 'center';
                    avatar.style.justifyContent = 'center';
                    avatar.style.fontWeight = 'bold';
                    avatar.style.marginRight = '10px';
                    avatar.textContent = getInitials(user.username);
                    
                    // Create user info
                    const userInfo = document.createElement('div');
                    userInfo.style.flex = '1';
                    userInfo.textContent = user.username;
                    
                    userItem.appendChild(avatar);
                    userItem.appendChild(userInfo);
                    
                    userItem.onclick = () => {
                        if (selectedNewUsers.includes(user.id)) {
                            selectedNewUsers = selectedNewUsers.filter(id => id !== user.id);
                            userItem.style.backgroundColor = '';
                        } else {
                            selectedNewUsers.push(user.id);
                            userItem.style.backgroundColor = '#f0f0f0';
                        }
                    };
                    searchResults.appendChild(userItem);
                });
            }
        });

        // Add selected users to group
        const addSelectedUsersBtn = document.getElementById('addSelectedUsersBtn');
        addSelectedUsersBtn.addEventListener('click', async () => {
            if (!currentChatId || selectedNewUsers.length === 0) {
                alert('Please select users to add');
                return;
            }

            try {
                const response = await fetchWithAuth('/groupAdd', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        chatId: currentChatId,
                        usersArr: selectedNewUsers
                    })
                });

                if (!response) return; // Redirect happened
                
                const data = await response.json();
                if (data.chat) {
                    showNotification('Users added successfully!');
                    document.getElementById('addUsersPopup').style.display = 'none';
                    
                    // Update the participants list with the new participants
                    const newParticipants = data.participants.map(p => ({
                        chat_id: currentChatId,
                        user_id: p.id,
                        username: p.username,
                        role: p.role
                    }));
                    
                    currentChatParticipants = newParticipants;
                    
                    // Update the view users popup if it's open
                    if (document.getElementById('userListPopup').style.display === 'block') {
                        showUsers(currentChat, currentChatParticipants);
                    }
                } else {
                    alert('Failed to add users');
                }
            } catch (error) {
                console.error('Error adding users:', error);
                alert('Error adding users');
            }
        });

        // Create new group chat
        document.getElementById('createGroupBtn').addEventListener('click', async () => {
            const groupName = document.getElementById('groupName').value.trim();
            if (!groupName || selectedUsers.length < 1) {
                alert('Please provide a group name and select users.');
                return;
            }

            try {
                const response = await fetchWithAuth('/createGroup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        chatName: groupName,
                        usersArr: selectedUsers
                    })
                });

                if (!response) return; // Redirect happened
                
                const data = await response.json();
                if (data.chat) {
                    showNotification('Group created successfully!');
                    fetchChats();
                    document.getElementById('newGroupPopup').style.display = 'none';
                    selectedUsers = [];
                    document.getElementById('groupName').value = '';
                    document.getElementById('searchResults').innerHTML = '';
                } else {
                    alert('Failed to create group');
                }
            } catch (error) {
                console.error('Error creating group:', error);
                alert('Error creating group');
            }
        });

        // Rename group confirmation
        document.getElementById('confirmRenameGroupBtn').addEventListener('click', async () => {
            const newGroupName = document.getElementById('newGroupName').value.trim();
            if (!newGroupName) {
                alert('Please enter a new group name');
                return;
            }

            try {
                const response = await fetchWithAuth('/renameGroup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        newGroupName: newGroupName,
                        chatId: currentChatId
                    })
                });

                if (!response) return; // Redirect happened
                
                const data = await response.json();
                if (response.ok) {
                    // Update the chat title in the UI
                    document.getElementById('chatTitle').textContent = newGroupName;
                    document.getElementById('chatAvatar').textContent = getInitials(newGroupName);
                    document.getElementById('chatAvatar').style.backgroundColor = getAvatarColor(newGroupName);
                    currentChat.groupName = newGroupName;
                    
                    // Update the chat list item
                    const chatItem = document.querySelector(`.chat-item[data-chat-id="${currentChatId}"]`);
                    if (chatItem) {
                        const nameElement = chatItem.querySelector('.chat-name');
                        if (nameElement) {
                            nameElement.firstChild.textContent = newGroupName;
                        }
                        const avatar = chatItem.querySelector('.chat-avatar');
                        if (avatar) {
                            avatar.textContent = getInitials(newGroupName);
                            avatar.style.backgroundColor = getAvatarColor(newGroupName);
                        }
                    }
                    
                    document.getElementById('renameGroupPopup').style.display = 'none';
                    showNotification('Group name updated successfully');
                } else {
                    throw new Error(data.message || 'Failed to rename group');
                }
            } catch (error) {
                console.error('Error renaming group:', error);
                alert(error.message);
            }
        });

        // Handle incoming messages from socket.io
        socket.on('receiveMessage', (data) => {
            // Initialize messages array for this chat if it doesn't exist
            if (!messagesData[data.chatId]) {
                messagesData[data.chatId] = [];
            }
            
            // Add the new message to our storage
            messagesData[data.chatId].push(data);
            
            // Update the chat window if it's the current chat
            if (data.chatId == currentChatId) {
                appendMessage(data);
            }
            
            // Update the chat list item with the new last message and move to top
            moveChatToTop(data.chatId, data);
            
            // Show notification if the message is not from current user and not in the chat window
            if (data.sender.senderId !== userId && data.chatId !== currentChatId) {
                incrementUnreadCount(data.chatId);
                showNotification(data);
            }
        });

        // Handle message deleted event from socket.io
        socket.on('messageDeleted', (chatId, updatedMessage) => {
            // Update the message in our messagesData storage
            if (messagesData[chatId]) {
                const messageIndex = messagesData[chatId].findIndex(m => m.id === updatedMessage.id);
                if (messageIndex !== -1) {
                    messagesData[chatId][messageIndex] = updatedMessage;
                }
            }
            
            // Update the message in the UI if this is the current chat
            if (chatId === currentChatId) {
                const messageElement = document.querySelector(`.message[data-message-id="${updatedMessage.id}"]`);
                if (messageElement) {
                    const messageContent = messageElement.querySelector('div:not(.message-time):not(.message-sender)');
                    if (messageContent) {
                        messageContent.innerHTML = `<i>${updatedMessage.message}</i>`;
                    }
                    
                    // Remove the delete button if it exists
                    const deleteBtn = messageElement.querySelector('.delete-message-btn');
                    if (deleteBtn) {
                        deleteBtn.remove();
                    }
                }
            }
            
            // Update the last message in the chat list if this was the last message
            const chatItem = document.querySelector(`.chat-item[data-chat-id="${chatId}"]`);
            if (chatItem) {
                const lastMessageElement = chatItem.querySelector('.chat-last-message');
                if (lastMessageElement) {
                    lastMessageElement.firstChild.textContent = formatLastMessage(updatedMessage);
                }
            }
        });

        // Handle new chat event from socket.io
        socket.on('newChat', (chat, participants) => {
            // Add the new chat to the allChats array
            allChats.unshift(chat);
            
            // Add the chat to the chat list UI
            addChatToList(chat, participants, userId);
            
            // Show notification
            if (chat.isGroup) {
                showNotification(`You've been added to a new group: ${chat.groupName}`);
            } else {
                const otherUser = participants.find(p => p.user_id !== userId);
                if (otherUser) {
                    showNotification(`You have a new chat with ${otherUser.username}`);
                }
            }
            
            // Join the chat room
            socket.emit('join chat', [chat.id]);
        });

        // Handle group name change event
        socket.on('newGroupName', (chatId, newGroupName) => {
            // Update the chat title if this is the current chat
            if (currentChatId === chatId) {
                document.getElementById('chatTitle').textContent = newGroupName;
                document.getElementById('chatAvatar').textContent = getInitials(newGroupName);
                document.getElementById('chatAvatar').style.backgroundColor = getAvatarColor(newGroupName);
                currentChat.groupName = newGroupName;
            }

            // Update the chat list item
            const chatItem = document.querySelector(`.chat-item[data-chat-id="${chatId}"]`);
            if (chatItem) {
                const nameElement = chatItem.querySelector('.chat-name');
                if (nameElement) {
                    nameElement.firstChild.textContent = newGroupName;
                }
                const avatar = chatItem.querySelector('.chat-avatar');
                if (avatar) {
                    avatar.textContent = getInitials(newGroupName);
                    avatar.style.backgroundColor = getAvatarColor(newGroupName);
                }
            }

            // Update in allChats array
            const chat = allChats.find(c => c.id === chatId);
            if (chat) {
                chat.groupName = newGroupName;
            }
        });

        // Handle updated participants list
        socket.on('updateChatParticipantsList', (chatId, participants) => {
            // If this is the current chat, update the participants list
            if (currentChatId === chatId) {
                currentChatParticipants = participants;
                
                // If the user list popup is open, update it
                if (document.getElementById('userListPopup').style.display === 'block') {
                    showUsers(currentChat, participants);
                }
                
                // Check if current user is still in the group
                const currentUserStillInGroup = participants.some(p => p.user_id === userId);
                if (!currentUserStillInGroup) {
                    // User was removed from the group
                    document.getElementById('chatWindow').style.display = 'none';
                    
                    // Remove messages from storage for this chat
                    delete messagesData[chatId];
                    
                    showNotification('You have been removed from this group');
                }
            }
            
            // Update the chat list to reflect any changes
            fetchChats();
        });

        // Handle chat removal
        socket.on('removeChat', (chatId) => {
            // Remove the chat from the chat list
            const chatItem = document.querySelector(`.chat-item[data-chat-id="${chatId}"]`);
            if (chatItem) {
                chatItem.remove();
            }
            
            // If this was the current chat, close the chat window
            if (currentChatId === chatId) {
                document.getElementById('chatWindow').style.display = 'none';
                currentChatId = null;
                currentChat = null;
                showNotification('This chat has been deleted');
            }
            
            // Remove from allChats array
            allChats = allChats.filter(chat => chat.id !== chatId);
            
            // Remove messages from storage
            delete messagesData[chatId];
        });

        // Move chat to top of the list when new message arrives
        function moveChatToTop(chatId, message) {
            const chatList = document.getElementById('chatList');
            const chatItem = document.querySelector(`.chat-item[data-chat-id="${chatId}"]`);
            
            if (chatItem) {
                // Remove the chat item from its current position
                chatItem.remove();
                
                // Update the content with the new message
                const messageRow = chatItem.querySelector('.chat-last-message');
                if (messageRow) {
                    const chatName = chatItem.querySelector('.chat-name').firstChild.textContent;
                    messageRow.firstChild.textContent = message.isSystem ? 
                        message.message : 
                        `${message.sender.username}: ${message.message}`;
                }
                
                // Update the time
                const timeSpan = chatItem.querySelector('.chat-time');
                if (timeSpan) {
                    timeSpan.textContent = formatTime(message.created_at);
                }
                
                // Add the chat item back at the top of the list
                chatList.insertBefore(chatItem, chatList.firstChild);
            }
        }

        // Increment unread count for a chat
        function incrementUnreadCount(chatId) {
            if (!unreadCounts[chatId]) {
                unreadCounts[chatId] = 0;
            }
            unreadCounts[chatId]++;
            
            // Update the UI
            const chatItem = document.querySelector(`.chat-item[data-chat-id="${chatId}"]`);
            if (chatItem) {
                let badge = chatItem.querySelector('.unread-count');
                if (!badge) {
                    badge = document.createElement('span');
                    badge.classList.add('unread-count');
                    const messageRow = chatItem.querySelector('.chat-last-message');
                    if (messageRow) {
                        messageRow.appendChild(badge);
                    }
                }
                badge.textContent = unreadCounts[chatId];
            }
        }

        // Show notification for new message
        function showNotification(data) {
            const notification = document.getElementById('notification');
            if (typeof data === 'string') {
                notification.textContent = data;
            } else {
                const chat = allChats.find(c => c.id === data.chatId);
                const chatName = chat?.isGroup ? chat.groupName : 
                    currentChatParticipants.find(p => p.user_id === data.sender.senderId)?.username || 'Unknown';
                
                notification.textContent = `New message in ${chatName}: ${data.message.substring(0, 30)}${data.message.length > 30 ? '...' : ''}`;
            }
            notification.style.display = 'block';
            
            // Hide after 5 seconds
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }
         document.getElementById('logoutBtn').addEventListener('click', () => {
        document.getElementById('logoutConfirmationPopup').style.display = 'block';
    });

    document.getElementById('closeLogoutPopup').addEventListener('click', () => {
        document.getElementById('logoutConfirmationPopup').style.display = 'none';
    });

    document.getElementById('cancelLogoutBtn').addEventListener('click', () => {
        document.getElementById('logoutConfirmationPopup').style.display = 'none';
    });

    document.getElementById('confirmLogoutBtn').addEventListener('click', async () => {
        try {
            const response = await fetch('/logout', {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            if (response.status === 200) {
                localStorage.removeItem('token');
                localStorage.removeItem('userId');
                window.location.href = '/login';
            } else {
                alert('Failed to logout');
            }
        } catch (err) {
            console.error('Logout error:', err);
            alert('Logout error');
        }
    });     
        // Initialize chat list
        fetchChats();
    </script>
</body>
</html>
